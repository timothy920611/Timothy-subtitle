<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JW å­—å¹•æå–å™¨ (AI æ™ºèƒ½ç‰ˆ)</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- App Icon -->
    <link rel="apple-touch-icon" href="https://assetsnffrgf-a.akamaihd.net/assets/m/802013146/univ/art/802013146_univ_sqr_xl.jpg">
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        textarea::-webkit-scrollbar { width: 10px; }
        textarea::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 8px; }
        textarea::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; border: 2px solid #f1f5f9; }
        textarea::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Markdown Styles */
        .prose h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #0f172a; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.3em; }
        .prose p { margin-bottom: 0.8em; }
        .prose strong { color: #047857; font-weight: 700; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        // Icons
        const Icons = {
            ShieldCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Loader2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            ExternalLink: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            Clipboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 9h4"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Lightbulb: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 1-2-2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V2a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        };

        const App = () => {
            const [url, setUrl] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [status, setStatus] = React.useState('idle'); 
            const [errorMsg, setErrorMsg] = React.useState('');
            const [result, setResult] = React.useState(null);
            const [copyState, setCopyState] = React.useState(false);
            
            const [manualInput, setManualInput] = React.useState('');
            const [targetId, setTargetId] = React.useState('');
            const [targetLang, setTargetLang] = React.useState('CH');
            const [foundVttUrl, setFoundVttUrl] = React.useState('');

            // AI Features State
            const [apiKey, setApiKey] = React.useState('');
            const [showSettings, setShowSettings] = React.useState(false);
            const [aiStatus, setAiStatus] = React.useState('idle'); // idle, loading, success, error
            const [aiResult, setAiResult] = React.useState('');
            const [aiType, setAiType] = React.useState('');

            // Load API Key from LocalStorage
            React.useEffect(() => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) setApiKey(storedKey);
            }, []);

            const saveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('gemini_api_key', key);
            };

            const PROXIES = [
                'https://corsproxy.io/?',
                'https://api.allorigins.win/raw?url='
            ];

            const cleanVttText = (vttContent) => {
                if (!vttContent) return '';
                const txt = document.createElement("textarea");
                const decode = (str) => { txt.innerHTML = str; return txt.value; };

                const lines = vttContent.split('\n');
                let cleanLines = [];
                
                lines.forEach(line => {
                let text = line.trim();
                if (!text) return;
                if (text.startsWith('WEBVTT') || text.startsWith('NOTE') || text.startsWith('STYLE')) return;
                if (text.includes('-->')) return; 
                if (/^\d+$/.test(text)) return; 

                text = text.replace(/<\/?[^>]+(>|$)/g, "");
                text = decode(text);
                
                if (cleanLines.length > 0 && cleanLines[cleanLines.length - 1] === text) return;
                cleanLines.push(text);
                });

                return cleanLines.join('\n');
            };

            const parseUrlInfo = (inputUrl) => {
                try {
                const info = { id: null, lang: 'CH' };
                const u = new URL(inputUrl.startsWith('http') ? inputUrl : `https://${inputUrl}`);
                if (u.searchParams.get('lank')) info.id = u.searchParams.get('lank');
                if (u.searchParams.get('wtlocale')) info.lang = u.searchParams.get('wtlocale');
                if (!info.id) {
                    const match = inputUrl.match(/(pub-[a-zA-Z0-9-_]+)/i);
                    if (match) info.id = match[1];
                }
                return info;
                } catch (e) {
                return { id: null, lang: 'CH' };
                }
            };

            const handleStart = async () => {
                if (!url) return;
                setLoading(true);
                setErrorMsg('');
                setResult(null);
                setAiResult(''); // Clear previous AI result
                setAiStatus('idle');
                setStatus('auto_fetching');
                setManualInput('');

                const { id, lang } = parseUrlInfo(url);
                if (!id) {
                    setLoading(false);
                    setErrorMsg('ç„¡æ³•è­˜åˆ¥å½±ç‰‡ IDã€‚è«‹ç¢ºèªç¶²å€åŒ…å« "pub-..." æˆ– "lank=..."ã€‚');
                    return;
                }
                setTargetId(id);
                setTargetLang(lang);
                const apiUrl = `https://b.jw-cdn.org/apis/mediator/v1/media-items/${lang}/${id}?clientType=www`;
                
                try {
                    let response = await fetch(PROXIES[0] + encodeURIComponent(apiUrl));
                    if (!response.ok) response = await fetch(PROXIES[1] + encodeURIComponent(apiUrl));
                    if (!response.ok) throw new Error('Auto fetch failed');
                    const data = await response.json();
                    processJsonData(data);
                } catch (err) {
                    console.warn('Auto fetch failed, switching to manual mode', err);
                    setLoading(false);
                    setStatus('manual_json_needed');
                }
            };

            const processJsonData = async (data) => {
                try {
                    const files = data.media?.[0]?.files || [];
                    const title = data.media?.[0]?.title || targetId;
                    const subFile = files.find(f => f.label === 'subtitles' || f.subtitles?.url);
                    if (!subFile) throw new Error('æ­¤å½±ç‰‡è³‡æ–™ä¸­æ‰¾ä¸åˆ°å­—å¹•æª” (Subtitles not found in JSON).');

                    const vttUrl = subFile.subtitles?.url || subFile.url;
                    setFoundVttUrl(vttUrl);
                    setStatus('auto_fetching'); 

                    try {
                        let response = await fetch(PROXIES[0] + encodeURIComponent(vttUrl));
                        if (!response.ok) response = await fetch(PROXIES[1] + encodeURIComponent(vttUrl));
                        if (!response.ok) throw new Error('VTT fetch failed');
                        const text = await response.text();
                        setResult({ clean: cleanVttText(text), title });
                        setStatus('success');
                        setLoading(false);
                    } catch (err) {
                        console.warn('VTT fetch failed, switching to manual mode');
                        setLoading(false);
                        setStatus('manual_vtt_needed');
                    }
                } catch (err) {
                    setLoading(false);
                    setErrorMsg('è§£æè³‡æ–™å¤±æ•—ï¼š' + err.message);
                    setStatus('manual_json_needed');
                }
            };

            const handleManualJsonSubmit = () => {
                try {
                    const json = JSON.parse(manualInput);
                    processJsonData(json);
                } catch (e) {
                    setErrorMsg('è²¼ä¸Šçš„å…§å®¹æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æ‚¨è¤‡è£½äº†å®Œæ•´çš„ JSON æ–‡å­—ã€‚');
                }
            };

            const handleManualVttSubmit = () => {
                if (!manualInput) return;
                setResult({ clean: cleanVttText(manualInput), title: 'Manual Extract' });
                setStatus('success');
            };

            const copyResult = () => {
                if (!result) return;
                const textArea = document.createElement("textarea");
                textArea.value = result.clean;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                setCopyState(true);
                setTimeout(() => setCopyState(false), 2000);
            };

            // AI Functions
            const callGemini = async (type) => {
                // If no key in settings, check environment (for preview) or show error
                let currentKey = apiKey;
                
                // Fallback for canvas preview environment if applicable (user won't have this, but for dev it's useful)
                if (!currentKey && typeof window !== 'undefined') {
                   // No-op here, rely on user input
                }

                if (!currentKey) {
                    setShowSettings(true);
                    return;
                }

                if (!result || !result.clean) return;

                setAiStatus('loading');
                setAiType(type);
                setAiResult('');

                let prompt = "";
                const context = result.clean.substring(0, 30000); // Limit context length to avoid token limits

                if (type === 'summary') {
                    prompt = `è«‹æ‰®æ¼”ä¸€ä½å°ˆæ¥­çš„ç ”è®€åŠ©ç†ï¼Œç‚ºä»¥ä¸‹é€™æ®µå½±ç‰‡çš„å­—å¹•å…§å®¹æä¾›ä¸€ä»½ç¹é«”ä¸­æ–‡çš„ã€Œé‡é»æ‘˜è¦ã€ã€‚\n\nè¦æ±‚ï¼š\n1. ä½¿ç”¨ Markdown æ ¼å¼ã€‚\n2. åˆ—å‡º 3-5 å€‹ä¸»è¦è«–é»ã€‚\n3. èªæ°£è¦é¼“å‹µä¸”æ­£é¢ã€‚\n\nå…§å®¹ï¼š\n${context}`;
                } else if (type === 'quiz') {
                    prompt = `è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹ï¼Œè¨­è¨ˆ 3-5 å€‹ç”¨æ–¼ã€Œå€‹äººç ”è®€ã€æˆ–ã€Œå°çµ„è¨è«–ã€çš„æ€è€ƒå•é¡Œã€‚\n\nè¦æ±‚ï¼š\n1. å•é¡Œè¦èƒ½å¼•ç™¼æ·±å±¤æ€è€ƒï¼Œè€Œä¸åƒ…åƒ…æ˜¯å›æ†¶äº‹å¯¦ã€‚\n2. é™„ä¸Šæ¯å€‹å•é¡Œå°æ‡‰çš„ç°¡çŸ­åƒè€ƒç­”æ¡ˆæˆ–æ€è·¯ã€‚\n3. ä½¿ç”¨ç¹é«”ä¸­æ–‡ Markdown æ ¼å¼ã€‚\n\nå…§å®¹ï¼š\n${context}`;
                } else if (type === 'action') {
                    prompt = `è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹ï¼Œæä¾› 3 é»å…·é«”çš„ã€Œç”Ÿæ´»æ‡‰ç”¨å»ºè­°ã€(Action Items)ã€‚\n\nè¦æ±‚ï¼š\n1. é‡å°æ—¥å¸¸ç”Ÿæ´»ã€å·¥ä½œæˆ–å®¶åº­ã€‚\n2. å…·é«”ä¸”å¯åŸ·è¡Œã€‚\n3. ä½¿ç”¨ç¹é«”ä¸­æ–‡ Markdown æ ¼å¼ã€‚\n\nå…§å®¹ï¼š\n${context}`;
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (aiText) {
                        setAiResult(aiText);
                        setAiStatus('success');
                    } else {
                        throw new Error('No content generated');
                    }

                } catch (e) {
                    setAiStatus('error');
                    setAiResult(`AI åˆ†æå¤±æ•—: ${e.message}\nè«‹æª¢æŸ¥ API Key æ˜¯å¦æ­£ç¢ºã€‚`);
                }
            };

            const getDirectApiUrl = () => `https://b.jw-cdn.org/apis/mediator/v1/media-items/${targetLang}/${targetId}?clientType=www`;

            const isSuccess = status === 'success' && result;
            const containerClass = isSuccess 
                ? "flex-1 w-full max-w-[1600px] mx-auto p-4 md:p-6 transition-all duration-500 ease-out" 
                : "flex-1 w-full max-w-lg mx-auto p-4 flex flex-col justify-center transition-all duration-500 ease-out";
            
            const layoutClass = isSuccess
                ? "flex flex-col md:flex-row gap-6 h-full"
                : "flex flex-col gap-6";

            return (
                <>
                {/* Header */}
                <div className="bg-slate-800 text-white p-4 shadow-md shrink-0 z-20 flex justify-between items-center">
                    <div className={`flex items-center gap-3 transition-all duration-500 ${isSuccess ? '' : ''}`}>
                        <div className="text-emerald-400"><Icons.ShieldCheck /></div>
                        <div>
                            <h1 className="text-lg font-bold">JW å­—å¹•æå–</h1>
                            <p className="text-[12px] text-slate-400"> å°é›æ™ºèƒ½ç‰ˆ ğŸ¥ </p>
                        </div>
                    </div>
                    
                    {/* Settings Button */}
                    <button 
                        onClick={() => setShowSettings(true)}
                        className={`p-2 rounded-full hover:bg-slate-700 transition-colors ${!apiKey ? 'animate-pulse text-yellow-300' : 'text-slate-400'}`}
                        title="è¨­å®š API Key"
                    >
                        <Icons.Settings />
                    </button>
                </div>

                {/* Settings Modal */}
                {showSettings && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl animate-in zoom-in-95">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icons.Sparkles className="text-purple-600"/> Gemini API è¨­å®š
                                </h3>
                                <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600"><Icons.X /></button>
                            </div>
                            <p className="text-sm text-slate-600 mb-4">
                                è¦ä½¿ç”¨ AI æ‘˜è¦èˆ‡å•ç­”åŠŸèƒ½ï¼Œè«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Keyã€‚<br/>
                                <span className="text-xs text-slate-400">(Key æœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³åˆ°å…¶ä»–åœ°æ–¹)</span>
                            </p>
                            
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">API Key</label>
                            <input 
                                type="password" 
                                value={apiKey}
                                onChange={(e) => setApiKey(e.target.value)}
                                placeholder="AIzaSy..."
                                className="w-full p-3 border border-slate-300 rounded-xl mb-4 focus:ring-2 focus:ring-purple-500 outline-none font-mono text-sm"
                            />
                            
                            <div className="flex gap-2 text-sm text-blue-600 mb-6">
                                <Icons.ExternalLink className="w-4 h-4" />
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="hover:underline">å…è²»ç²å– Gemini API Key</a>
                            </div>

                            <button 
                                onClick={() => { saveApiKey(apiKey); setShowSettings(false); }}
                                className="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-bold shadow-lg shadow-purple-200"
                            >
                                å„²å­˜è¨­å®š
                            </button>
                        </div>
                    </div>
                )}

                <div className="overflow-y-auto h-full w-full bg-slate-50/50">
                    <div className={containerClass}>
                        <div className={layoutClass}>

                            {/* Left Panel */}
                            <div className={`flex flex-col gap-6 transition-all duration-500 ${isSuccess ? 'w-full md:w-1/3 lg:w-1/4 shrink-0' : 'w-full'}`}>
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                                    <label className="block text-sm font-bold text-slate-600 mb-2">
                                        {isSuccess ? 'æå–ä¸‹ä¸€éƒ¨å½±ç‰‡' : 'è¼¸å…¥å½±ç‰‡ç¶²å€ (Finder æˆ– é•·é€£çµ)'}
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            value={url}
                                            onChange={(e) => setUrl(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && handleStart()}
                                            placeholder="https://..."
                                            className="w-full p-3 bg-slate-50 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none pr-10"
                                        />
                                        {url && (
                                            <button onClick={() => setUrl('')} className="absolute right-3 top-3 text-slate-400 hover:text-slate-600">Ã—</button>
                                        )}
                                    </div>
                                    
                                    <button
                                        onClick={handleStart}
                                        disabled={loading || !url}
                                        className="mt-3 w-full py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold flex justify-center items-center gap-2 transition-colors disabled:bg-slate-300 shadow-emerald-200 shadow-md"
                                    >
                                        {loading ? <div className="animate-spin"><Icons.Loader2 className="w-5 h-5" /></div> : <Icons.Search />}
                                        {loading ? 'è™•ç†ä¸­...' : 'é–‹å§‹æå–'}
                                    </button>
                                    
                                    {errorMsg && (
                                        <div className="mt-4 p-3 bg-red-50 text-red-700 rounded-lg text-xs flex gap-2 border border-red-100">
                                            <div className="shrink-0 mt-0.5"><Icons.AlertTriangle className="w-4 h-4" /></div>
                                            {errorMsg}
                                        </div>
                                    )}
                                </div>

                                {status === 'manual_json_needed' && (
                                    <div className="bg-white p-5 rounded-2xl shadow-lg border-2 border-amber-100 animate-in slide-in-from-bottom-4">
                                        <div className="flex items-center gap-2 text-amber-700 font-bold mb-3 text-sm">
                                            <Icons.AlertTriangle className="w-5 h-5" /> æ‰‹å‹•è¼”åŠ©æ¨¡å¼
                                        </div>
                                        <a href={getDirectApiUrl()} target="_blank" rel="noopener noreferrer" className="block w-full text-center py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-bold mb-3 hover:bg-blue-200">
                                            1. æ‰“é–‹è³‡æ–™é é¢ <Icons.ExternalLink className="w-3 h-3 inline" />
                                        </a>
                                        <textarea value={manualInput} onChange={(e) => setManualInput(e.target.value)} placeholder="2. è²¼ä¸Šå…§å®¹..." className="w-full h-24 p-3 bg-slate-50 border border-slate-300 rounded-xl text-xs font-mono mb-3" />
                                        <button onClick={handleManualJsonSubmit} disabled={!manualInput} className="w-full py-2 bg-amber-600 text-white rounded-lg font-bold text-sm">ä¸‹ä¸€æ­¥</button>
                                    </div>
                                )}

                                {status === 'manual_vtt_needed' && (
                                    <div className="bg-white p-5 rounded-2xl shadow-lg border-2 border-blue-100 animate-in slide-in-from-bottom-4">
                                        <div className="flex items-center gap-2 text-blue-700 font-bold mb-3 text-sm">
                                            <Icons.FileText className="w-5 h-5" /> æ‰¾åˆ°å­—å¹•äº†
                                        </div>
                                        <a href={foundVttUrl} target="_blank" rel="noopener noreferrer" className="block w-full text-center py-2 bg-emerald-100 text-emerald-700 rounded-lg text-sm font-bold mb-3 hover:bg-emerald-200 truncate px-2">
                                            1. ä¸‹è¼‰å­—å¹•æª” <Icons.ExternalLink className="w-3 h-3 inline" />
                                        </a>
                                        <textarea value={manualInput} onChange={(e) => setManualInput(e.target.value)} placeholder="2. è²¼ä¸Šå­—å¹•å…§å®¹..." className="w-full h-24 p-3 bg-slate-50 border border-slate-300 rounded-xl text-xs font-mono mb-3" />
                                        <button onClick={handleManualVttSubmit} disabled={!manualInput} className="w-full py-2 bg-blue-600 text-white rounded-lg font-bold text-sm">æ¸…ç†ä¸¦é¡¯ç¤º</button>
                                    </div>
                                )}
                            </div>

                            {/* Right Panel: Result */}
                            {isSuccess && (
                                <div className="w-full md:w-2/3 lg:w-3/4 flex flex-col h-full gap-4 animate-in fade-in slide-in-from-right-4 duration-500">
                                    
                                    {/* AI Toolbar */}
                                    <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 flex flex-wrap gap-2 items-center">
                                        <div className="px-2 flex items-center gap-2 text-slate-700 font-bold text-sm border-r border-slate-200 mr-2">
                                            <Icons.Sparkles className="text-purple-500 w-5 h-5" />
                                            AI æ™ºæ…§åˆ†æ
                                        </div>
                                        <button onClick={() => callGemini('summary')} className="flex items-center gap-1.5 px-3 py-1.5 bg-purple-50 text-purple-700 hover:bg-purple-100 rounded-lg text-sm font-medium transition-colors">
                                            <Icons.FileText className="w-4 h-4"/> é‡é»æ‘˜è¦
                                        </button>
                                        <button onClick={() => callGemini('quiz')} className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 hover:bg-blue-100 rounded-lg text-sm font-medium transition-colors">
                                            <Icons.Brain className="w-4 h-4"/> æ€è€ƒå•é¡Œ
                                        </button>
                                        <button onClick={() => callGemini('action')} className="flex items-center gap-1.5 px-3 py-1.5 bg-amber-50 text-amber-700 hover:bg-amber-100 rounded-lg text-sm font-medium transition-colors">
                                            <Icons.Lightbulb className="w-4 h-4"/> è¡Œå‹•å»ºè­°
                                        </button>
                                    </div>

                                    {/* AI Result Area (Conditional) */}
                                    {aiStatus !== 'idle' && (
                                        <div className="bg-gradient-to-br from-purple-50 to-white p-6 rounded-2xl shadow-lg border border-purple-100 animate-in slide-in-from-top-4 relative">
                                            <button onClick={() => setAiStatus('idle')} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icons.X /></button>
                                            
                                            {aiStatus === 'loading' && (
                                                <div className="flex flex-col items-center justify-center py-8 text-purple-600 gap-3">
                                                    <Icons.Loader2 className="animate-spin w-8 h-8" />
                                                    <p className="text-sm font-medium animate-pulse">Gemini æ­£åœ¨åˆ†æå…§å®¹...</p>
                                                </div>
                                            )}
                                            
                                            {aiStatus === 'error' && (
                                                <div className="text-red-600 flex gap-3 p-2">
                                                    <Icons.AlertTriangle className="shrink-0" />
                                                    <div className="whitespace-pre-line text-sm">{aiResult}</div>
                                                </div>
                                            )}

                                            {aiStatus === 'success' && (
                                                <div className="prose prose-sm max-w-none text-slate-700">
                                                    <div dangerouslySetInnerHTML={{ __html: marked.parse(aiResult) }} />
                                                    <div className="mt-4 pt-4 border-t border-purple-100 flex justify-end">
                                                        <button 
                                                            onClick={() => {
                                                                const el = document.createElement('textarea');
                                                                el.value = aiResult;
                                                                document.body.appendChild(el);
                                                                el.select();
                                                                document.execCommand('copy');
                                                                document.body.removeChild(el);
                                                            }}
                                                            className="text-xs text-purple-600 hover:text-purple-800 font-medium flex items-center gap-1"
                                                        >
                                                            <Icons.Clipboard className="w-3 h-3" /> è¤‡è£½åˆ†æçµæœ
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Main Text Area */}
                                    <div className="bg-white rounded-2xl shadow-xl border border-emerald-100 overflow-hidden flex flex-col flex-1 min-h-0">
                                        <div className="bg-emerald-600 text-white p-4 shrink-0 flex items-center justify-between">
                                            <div className="flex items-center gap-2 overflow-hidden">
                                                <Icons.Check className="shrink-0" />
                                                <h3 className="font-bold text-lg truncate">{result.title}</h3>
                                            </div>
                                            <button onClick={copyResult} className="bg-white/20 hover:bg-white/30 text-white text-xs px-3 py-1.5 rounded-lg font-medium transition-colors flex items-center gap-1 shrink-0">
                                                {copyState ? <Icons.Check className="w-3 h-3"/> : <Icons.Clipboard className="w-3 h-3"/>}
                                                {copyState ? 'å·²è¤‡è£½' : 'è¤‡è£½'}
                                            </button>
                                        </div>

                                        <div className="flex-1 p-0 relative bg-slate-100 group min-h-0">
                                            <textarea
                                                readOnly
                                                value={result.clean}
                                                className="w-full h-full p-6 md:p-8 bg-slate-50 text-slate-800 text-lg md:text-xl leading-relaxed resize-none focus:outline-none font-medium"
                                                style={{ fontFamily: '"Noto Sans TC", sans-serif' }}
                                            />
                                            <button 
                                                onClick={copyResult}
                                                className={`absolute bottom-6 right-6 p-4 rounded-full shadow-lg transition-all transform hover:scale-110 active:scale-95 flex items-center gap-2 font-bold ${copyState ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-white hover:bg-slate-900'}`}
                                            >
                                                {copyState ? <Icons.Check /> : <Icons.Clipboard />}
                                                <span className="hidden md:inline">{copyState ? 'è¤‡è£½æˆåŠŸ' : 'è¤‡è£½å…¨éƒ¨'}</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
